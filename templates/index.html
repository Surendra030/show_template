<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Video Grid</title>
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .card {
            border: 1px solid #ccc;
            padding: 10px;
        }

        .card img {
            width: 100%;
            height: auto;
        }

        .card-title {
            margin-top: 10px;
        }

        .status-box {
            margin-top: 20px;
            padding: 10px;
            color: white;
            font-weight: bold;
            display: none;
        }

        .status-box.red {
            background-color: red;
        }

        .status-box.green {
            background-color: green;
        }

        #loading {
            text-align: center;
            margin: 20px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>{{ message }}</h1>
    <p><strong>Server IP:</strong> {{ ip }}</p>

    <div id="statusBox" class="status-box"></div>
    <div id="resultBox"></div>

    <div class="grid" id="gridContainer"></div>
    <div id="loading">ðŸ”„ Loading more...</div>

    <script>
        const allData = {{ data | tojson | safe }};
        const grid = document.getElementById('gridContainer');
        const loading = document.getElementById('loading');
        const statusBox = document.getElementById('statusBox');
        const resultBox = document.getElementById('resultBox');

        let start = 0;
        const limit = 100;
        let loadingMore = false;

        function renderItems() {
            const end = Math.min(start + limit, allData.length);
            for (let i = start; i < end; i++) {
                const item = allData[i];
                let titleSlug = item.href.split('/').filter(Boolean).pop(); // removes empty strings

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${item.img}" alt="Image">
                    <div class="card-title">
                        <button onclick="fetchVideoData('${titleSlug}')">
                            ${item.title.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            }
            start += limit;
            loadingMore = false;
            if (start >= allData.length) {
                loading.style.display = 'none';
            }
        }
        function copyIP() {
            const ipText = document.getElementById('ipText').textContent;
            navigator.clipboard.writeText(ipText).then(() => {
                alert('âœ… IP copied to clipboard!');
            }).catch(err => {
                alert('âŒ Failed to copy IP');
                console.error(err);
            });
        }

        function fetchVideoData(titleSlug) {
            statusBox.className = 'status-box red';
            statusBox.style.display = 'block';
            statusBox.textContent = 'ðŸ”´ Sending API request...';

            fetch(`/fetch_video_info/${titleSlug}`)
                .then(response => {
                    if (!response.ok) throw new Error("Request failed");
                    return response.json();
                })
                .then(data => {
                    console.log(data)
                    statusBox.className = 'status-box green';
                    statusBox.textContent = 'ðŸŸ¢ Response received successfully!';
                    resultBox.innerHTML = `
                            <p><strong>Video URL:</strong></p>
<p>
    <a href="${data.video_url}" target="_blank">${data.video_url}</a>
</p>
<p>
    <strong>Server IP:</strong> 
    <span id="ipText">${data.ip_address}</span>
    <button onclick="copyIP()">ðŸ“‹ Copy</button>
</p>

                        `;
                })

                .catch(error => {
                    statusBox.className = 'status-box red';
                    statusBox.textContent = 'âŒ API request failed';
                    resultBox.innerHTML = '';
                    console.error(error);
                });
        }

        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 50 && !loadingMore) {
                loadingMore = true;
                setTimeout(renderItems, 200); // Slight delay for smoother feel
            }
        });

        // Initial render
        renderItems();
    </script>
</body>

</html>
